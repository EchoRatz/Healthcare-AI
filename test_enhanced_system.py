#!/usr/bin/env python3
"""
Test Enhanced Thai Healthcare Q&A System
Compare different AI approaches and validate improvements
"""

import os
import sys
import time
import json
import numpy as np
from typing import Dict, List

def test_parsing():
    """Test question parsing capability"""
    print("üß™ Testing Question Parsing")
    print("-" * 40)
    
    try:
        from enhanced_thai_qa_system import EnhancedThaiHealthcareQA
        
        # Initialize with minimal setup
        knowledge_files = [
            'Healthcare-AI-Refactored/src/infrastructure/results_doc/direct_extraction_corrected.txt'
        ]
        
        if not os.path.exists(knowledge_files[0]):
            print("‚ùå Knowledge file not found for testing")
            return False
        
        qa_system = EnhancedThaiHealthcareQA(knowledge_files)
        
        # Test questions
        test_questions = [
            "‡∏ú‡∏°‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å ‡∏≠‡πâ‡∏ß‡∏Å‡∏î‡πâ‡∏ß‡∏¢ ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡∏µ‡∏™‡∏≠‡∏á‡∏¢‡∏±‡∏á‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏Å‡πÑ‡∏´‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?  ‡∏Å. Endocrinology ‡∏Ç. Orthopedics ‡∏Ñ. Emergency ‡∏á. Internal Medicine",
            "‡∏¢‡∏≤ Clopidogrel mg tablet ‡πÉ‡∏ô‡∏õ‡∏µ 2567 ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡πÉ‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏°‡πá‡∏î‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å (OP)?  ‡∏Å. 2 ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏°‡πá‡∏î ‡∏Ç. 3 ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏°‡πá‡∏î ‡∏Ñ. 4 ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏°‡πá‡∏î ‡∏á. 5 ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏°‡πá‡∏î"
        ]
        
        for i, test_q in enumerate(test_questions, 1):
            print(f"\nüìù Test {i}:")
            question, choices = qa_system.parse_question(test_q)
            print(f"Question: {question[:50]}...")
            print(f"Choices extracted: {len(choices)}")
            for label, text in choices.items():
                print(f"  {label}. {text[:30]}...")
        
        print("\n‚úÖ Question parsing test passed")
        return True
        
    except Exception as e:
        print(f"‚ùå Question parsing test failed: {e}")
        return False

def test_ai_capabilities():
    """Test different AI model capabilities"""
    print("\nüß† Testing AI Model Capabilities")
    print("-" * 40)
    
    capabilities = {}
    
    # Test Sentence Transformers
    try:
        from sentence_transformers import SentenceTransformer
        model = SentenceTransformer('intfloat/multilingual-e5-large')
        test_texts = ["‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö", "test system"]
        embeddings = model.encode(test_texts)
        capabilities["Sentence Transformers"] = True
        print("‚úÖ Sentence Transformers: Available")
        print(f"   Model: multilingual-e5-large")
        print(f"   Embedding dimension: {embeddings.shape[1]}")
    except Exception as e:
        capabilities["Sentence Transformers"] = False
        print(f"‚ùå Sentence Transformers: Not available ({str(e)[:50]}...)")
    
    # Test FAISS
    try:
        import faiss
        # Test with small index
        dimension = 512
        index = faiss.IndexFlatIP(dimension)
        test_vectors = [[0.1] * dimension, [0.2] * dimension]
        index.add(np.array(test_vectors, dtype='float32'))
        capabilities["FAISS"] = True
        print("‚úÖ FAISS: Available")
    except Exception as e:
        capabilities["FAISS"] = False
        print(f"‚ùå FAISS: Not available ({str(e)[:50]}...)")
    
    # Test OpenAI
    openai_key = os.getenv('OPENAI_API_KEY')
    if openai_key:
        try:
            from openai import OpenAI
            client = OpenAI(api_key=openai_key)
            capabilities["OpenAI"] = True
            print("‚úÖ OpenAI: API key configured")
        except Exception as e:
            capabilities["OpenAI"] = False
            print(f"‚ùå OpenAI: Error ({str(e)[:50]}...)")
    else:
        capabilities["OpenAI"] = False
        print("‚ùå OpenAI: No API key (set OPENAI_API_KEY)")
    
    return capabilities

def test_processing_speed():
    """Test processing speed with different methods"""
    print("\n‚ö° Testing Processing Speed")
    print("-" * 40)
    
    try:
        # Test with original system
        print("Testing original system...")
        from thai_healthcare_qa_system import ThaiHealthcareQASystem
        
        knowledge_files = [
            'Healthcare-AI-Refactored/src/infrastructure/results_doc/direct_extraction_corrected.txt',
            'Healthcare-AI-Refactored/src/infrastructure/results_doc2/direct_extraction_corrected.txt',
            'Healthcare-AI-Refactored/src/infrastructure/results_doc3/direct_extraction_corrected.txt'
        ]
        
        # Check if files exist
        if not all(os.path.exists(f) for f in knowledge_files):
            print("‚ùå Knowledge files not found for speed test")
            return
        
        start_time = time.time()
        original_system = ThaiHealthcareQASystem(knowledge_files, memory_file="speed_test_memory.json")
        original_init_time = time.time() - start_time
        
        # Test enhanced system
        print("Testing enhanced system...")
        from enhanced_thai_qa_system import EnhancedThaiHealthcareQA
        
        start_time = time.time()
        enhanced_system = EnhancedThaiHealthcareQA(knowledge_files)
        enhanced_init_time = time.time() - start_time
        
        print(f"\nüìä Initialization Times:")
        print(f"  Original system: {original_init_time:.2f} seconds")
        print(f"  Enhanced system: {enhanced_init_time:.2f} seconds")
        
        # Test single question processing
        test_question = "‡∏ú‡∏°‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å ‡∏≠‡πâ‡∏ß‡∏Å‡∏î‡πâ‡∏ß‡∏¢ ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡∏µ‡∏™‡∏≠‡∏á‡∏¢‡∏±‡∏á‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏Å‡πÑ‡∏´‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?  ‡∏Å. Endocrinology ‡∏Ç. Orthopedics ‡∏Ñ. Emergency ‡∏á. Internal Medicine"
        
        # Original system
        question, choices = original_system.parse_question(test_question)
        start_time = time.time()
        original_result = original_system._chain_of_thought_reasoning(question, choices)
        original_question_time = time.time() - start_time
        
        # Enhanced system  
        question, choices = enhanced_system.parse_question(test_question)
        start_time = time.time()
        enhanced_result = enhanced_system._ensemble_prediction(question, choices)
        enhanced_question_time = time.time() - start_time
        
        print(f"\nüìä Single Question Processing:")
        print(f"  Original: {original_question_time:.3f} seconds")
        print(f"  Enhanced: {enhanced_question_time:.3f} seconds")
        
        print(f"\nüéØ Prediction Comparison:")
        print(f"  Original: {original_result.predicted_answers} (conf: {original_result.confidence:.3f})")
        print(f"  Enhanced: {enhanced_result.predicted_answers} (conf: {enhanced_result.confidence:.3f})")
        
        # Clean up test files
        if os.path.exists("speed_test_memory.json"):
            os.remove("speed_test_memory.json")
        
    except Exception as e:
        print(f"‚ùå Speed test failed: {e}")

def test_accuracy_comparison():
    """Compare accuracy between systems on sample questions"""
    print("\nüéØ Testing Accuracy Comparison")
    print("-" * 40)
    
    # Sample questions with expected answers (if known)
    test_cases = [
        {
            "question": "‡∏ú‡∏°‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å ‡∏≠‡πâ‡∏ß‡∏Å‡∏î‡πâ‡∏ß‡∏¢ ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡∏µ‡∏™‡∏≠‡∏á‡∏¢‡∏±‡∏á‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏Å‡πÑ‡∏´‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?  ‡∏Å. Endocrinology ‡∏Ç. Orthopedics ‡∏Ñ. Emergency ‡∏á. Internal Medicine",
            "expected": ["‡∏Ñ"],  # Emergency seems most appropriate
            "reasoning": "Emergency department for acute symptoms"
        },
        {
            "question": "‡∏Ç‡πâ‡∏≠‡πÉ‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏ß‡∏¥‡∏Å‡∏§‡∏ï‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢‡∏™‡∏¥‡∏ó‡∏ò‡∏¥ UCEP?  ‡∏Å. ‡πÄ‡∏à‡πá‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å‡πÄ‡∏â‡∏µ‡∏¢‡∏ö‡∏û‡∏•‡∏±‡∏ô‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á ‡∏Ç. ‡∏õ‡∏ß‡∏î‡∏´‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á ‡∏Ñ. ‡∏°‡∏µ‡πÑ‡∏Ç‡πâ‡∏™‡∏π‡∏á ‡∏á. ‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á",
            "expected": ["‡∏Å"],  # Acute severe chest pain is emergency
            "reasoning": "Acute severe chest pain is critical emergency"
        }
    ]
    
    try:
        knowledge_files = [
            'Healthcare-AI-Refactored/src/infrastructure/results_doc/direct_extraction_corrected.txt',
            'Healthcare-AI-Refactored/src/infrastructure/results_doc2/direct_extraction_corrected.txt',
            'Healthcare-AI-Refactored/src/infrastructure/results_doc3/direct_extraction_corrected.txt'
        ]
        
        if not all(os.path.exists(f) for f in knowledge_files):
            print("‚ùå Knowledge files not found for accuracy test")
            return
        
        # Initialize systems
        from thai_healthcare_qa_system import ThaiHealthcareQASystem
        from enhanced_thai_qa_system import EnhancedThaiHealthcareQA
        
        original_system = ThaiHealthcareQASystem(knowledge_files, memory_file="accuracy_test_memory.json")
        enhanced_system = EnhancedThaiHealthcareQA(knowledge_files)
        
        print(f"Testing {len(test_cases)} sample questions...")
        
        original_correct = 0
        enhanced_correct = 0
        
        for i, test_case in enumerate(test_cases, 1):
            print(f"\nüìù Test Case {i}:")
            print(f"Question: {test_case['question'][:60]}...")
            print(f"Expected: {test_case['expected']} ({test_case['reasoning']})")
            
            question, choices = original_system.parse_question(test_case['question'])
            
            # Original system
            original_result = original_system._chain_of_thought_reasoning(question, choices)
            original_match = any(ans in test_case['expected'] for ans in original_result.predicted_answers)
            if original_match:
                original_correct += 1
            
            # Enhanced system
            enhanced_result = enhanced_system._ensemble_prediction(question, choices)
            enhanced_match = any(ans in test_case['expected'] for ans in enhanced_result.predicted_answers)
            if enhanced_match:
                enhanced_correct += 1
            
            print(f"Original: {original_result.predicted_answers} {'‚úÖ' if original_match else '‚ùå'} (conf: {original_result.confidence:.3f})")
            print(f"Enhanced: {enhanced_result.predicted_answers} {'‚úÖ' if enhanced_match else '‚ùå'} (conf: {enhanced_result.confidence:.3f})")
        
        print(f"\nüìä Accuracy Results:")
        print(f"  Original system: {original_correct}/{len(test_cases)} ({original_correct/len(test_cases)*100:.1f}%)")
        print(f"  Enhanced system: {enhanced_correct}/{len(test_cases)} ({enhanced_correct/len(test_cases)*100:.1f}%)")
        
        if enhanced_correct > original_correct:
            print("üéâ Enhanced system shows improvement!")
        elif enhanced_correct == original_correct:
            print("üìä Systems perform similarly on this sample")
        else:
            print("‚ö†Ô∏è  Enhanced system needs tuning")
        
        # Clean up
        if os.path.exists("accuracy_test_memory.json"):
            os.remove("accuracy_test_memory.json")
            
    except Exception as e:
        print(f"‚ùå Accuracy test failed: {e}")

def main():
    """Run all enhanced system tests"""
    print("üöÄ Enhanced Thai Healthcare Q&A System - Testing Suite")
    print("=" * 60)
    
    try:
        # Test 1: Basic parsing
        parsing_success = test_parsing()
        
        # Test 2: AI capabilities
        capabilities = test_ai_capabilities()
        
        # Test 3: Processing speed (if parsing works)
        if parsing_success:
            test_processing_speed()
        
        # Test 4: Accuracy comparison (if parsing works)
        if parsing_success:
            test_accuracy_comparison()
        
        # Summary
        print(f"\nüìã Test Summary:")
        print(f"=" * 40)
        print(f"‚úÖ Question parsing: {'‚úÖ' if parsing_success else '‚ùå'}")
        print(f"üß† AI Capabilities:")
        for capability, available in capabilities.items():
            print(f"   {capability}: {'‚úÖ' if available else '‚ùå'}")
        
        # Recommendations
        print(f"\nüí° Recommendations:")
        if not capabilities.get("Sentence Transformers", False):
            print("  üì¶ Install sentence-transformers for better embeddings")
        if not capabilities.get("FAISS", False):
            print("  üì¶ Install faiss-cpu for faster vector search")
        if not capabilities.get("OpenAI", False):
            print("  üîë Set OPENAI_API_KEY for highest accuracy")
        
        print(f"\nüéØ Ready to run enhanced system:")
        print(f"   python enhanced_thai_qa_system.py")
        
    except Exception as e:
        print(f"‚ùå Testing failed: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    main()